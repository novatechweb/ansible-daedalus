---

- name: Install/Setup Docker images and containers on Daedalus
  hosts: daedalus
  become: true
  become_user: root
  become_method: sudo
  tags:
    - buildbot
    - buildbot-master
  vars:
    known_hosts: "{{gitlab_keys.stdout}}"
  tasks:
    - name: Scan Gitlab ssh keys
      command: ssh-keyscan {{gitlab_hostname}}
      register: gitlab_keys
      changed_when: false
    - name: Build and start the Buildbot master container
      import_role:
        name: buildbot-master

- name: Setup Buildbot worker system
  hosts: builder
  become: true
  become_user: root
  become_method: sudo
  tags:
    - buildbot
    - buildbot-worker
    - buildbot-worker-ntel
    - buildbot-worker-ptxdist
  vars:
    buildbot_master: "{{ buildbot_hostname }}"
    known_hosts: "{{ gitlab_keys.stdout }}"
  tasks:
    - name: Scan Gitlab ssh keys
      command: ssh-keyscan {{gitlab_hostname}}
      register: gitlab_keys
      changed_when: false
    - name: Build and start the Buildbot worker container
      import_role:
        name: buildbot-worker-ntel
    - name: Build and start the Buildbot worker container
      import_role:
        name: buildbot-worker-ptxdist
