Bottom: e24272a6e3f12345c585196cb07a4cdebbefd982
Top:    f914c2598ee4ffa690a47afe87912cafb45b7c36
Author: Andrew Cooper <andrew.cooper@novatechweb.com>
Date:   2018-05-22 13:51:33 -0500

Update gitlab to 10.1


---
diff --git a/ansible-playbook/gitlab.yml b/ansible-playbook/gitlab.yml
new file mode 100644
index 00000000..4d6482cd
--- /dev/null
+++ b/ansible-playbook/gitlab.yml
@@ -0,0 +1,126 @@
+---
+
+- name: Install/Setup Docker images and containers on daedalus
+  hosts: daedalus
+  remote_user: ansibleremote
+  become: true
+  become_user: root
+  become_method: sudo
+  tasks:
+  - set_fact:
+      openssl_dv_name: openssl_DV
+      bacula_storage: "/mnt/bacula-restores"
+      gitlab_backup_dir: "/tmp/docker/GIT"
+  - set_fact:
+      gitlab_backup_storage: "{{bacula_storage}}{{gitlab_backup_dir}}"
+      gitlab_restore_dir: "{{bacula_dest}}{{gitlab_backup_dir}}"
+
+  - file:
+      path: "{{item}}"
+      state: directory
+    loop:
+    - "{{ gitlab_backup_dir }}"
+    - "{{ gitlab_backup_storage }}"
+    - "{{ gitlab_restore_dir }}"
+
+  # - name: Gitlab 7.14.3
+  #   include_role: 
+  #     name: docker-gitlab
+  
+  # - name: Gitlab (Sameersbn 8)
+  #   vars:
+  #     gitlab_version: "8.0.5"
+  #     gitlab_image_tag: "8.0.5-1"
+  #     docker_name_prefix: 'sameersbn8-'
+  #     upgrade: true
+  #     old_prefix: ''
+  #   block:
+  #   - name: Run Gitlab
+  #     include_role:
+  #       name: gitlab-sameersbn-8
+  #   - name: Backup Gitlab
+  #     command: >
+  #       docker exec -u git {{docker_name_prefix}}gitlab bundle exec rake gitlab:backup:create
+  #   - name: Find backup files
+  #     find:
+  #       path: '{{gitlab_backup_dir}}'
+  #       pattern: '*_gitlab_backup.tar'
+  #     register: backups
+  #   - name: Move backups to storage, normalize name
+  #     loop: '{{ backups.files }}'
+  #     vars:
+  #       backup_file: '{{ item.path | basename | replace("gitlab_backup.tar", gitlab_version ~ "_gitlab_backup.tar") }}'
+  #     command: >
+  #       mv "{{ item.path }}" "{{gitlab_backup_storage}}/{{ backup_file }}"
+  #   - name: Shutdown Gitlab
+  #     docker_container: 
+  #       name: '{{ docker_name_prefix }}{{ item }}'
+  #       state: stopped
+  #     loop:
+  #     - gitlab
+  #     - gitlab-redis
+  #     - gitlab-db
+
+  # - name: Gitlab (Omnibus 8)
+  #   vars:
+  #     docker_name_prefix: 'omnibus8.0-'
+  #     gitlab_version: "8.0"
+  #     gitlab_image_tag: "8.0.5-ce.0"
+  #     upgrade: false
+  #     restore: true
+  #   block:
+  #   - name: Find relevant backups
+  #     find:
+  #       path: "{{gitlab_backup_storage}}"
+  #       pattern: "*_{{gitlab_version}}_*"
+  #     register: backups
+  #   - file:
+  #       src: '{{ item.path }}'
+  #       dest: '{{ item.path | replace(gitlab_backup_storage,gitlab_restore_dir) }}'
+  #       state: link
+  #       force: yes
+  #       mode: '{{ item.mode }}'
+  #     loop: '{{ backups.files }}'
+  #   - include_role:
+  #       name: gitlab-omnibus
+
+  - name: Gitlab Omnibus Upgrade Path
+    loop:
+    # - { last: "8.0.5",   version: "8.1",   tag: "8.1.4-ce.0"   }
+    # - { last: "8.1",   version: "8.2",   tag: "8.2.5-ce.2"   }
+    # - { last: "8.2",   version: "8.3",   tag: "8.3.10-ce.2"  }
+    # - { last: "8.3",   version: "8.4",   tag: "8.4.11-ce.2"  }
+    # - { last: "8.4",   version: "8.5",   tag: "8.5.13-ce.3"  } # reconfigure fail after uri
+    # - { last: "8.5",   version: "8.6",   tag: "8.6.9-ce.3"   }
+    # - { last: "8.6",   version: "8.7",   tag: "8.7.9-ce.1"   }
+    # - { last: "8.7",   version: "8.8",   tag: "8.8.9-ce.0"   } # Needs additional restart
+    # - { last: "8.8",   version: "8.9",   tag: "8.9.11-ce.0"  } # Needs additional restart
+    # - { last: "8.9",   version: "8.10",  tag: "8.10.13-ce.0" }
+    # - { last: "8.10",  version: "8.11",  tag: "8.11.11-ce.0" }
+    # - { last: "8.11",  version: "8.12",  tag: "8.12.13-ce.0" }
+    # - { last: "8.12",  version: "8.13",  tag: "8.13.12-ce.0" }
+    # - { last: "8.13",  version: "8.14",  tag: "8.14.10-ce.0" }
+    # - { last: "8.14",  version: "8.15",  tag: "8.15.8-ce.0"  }
+    # - { last: "8.15",  version: "8.16",  tag: "8.16.9-ce.0"  } # Health-check failure
+    # - { last: "8.16",  version: "8.17",  tag: "8.17.8-ce.0"  } # Health-check failure
+    # - { last: "8.17",  version: "9.0",   tag: "9.0.13-ce.0"  } # Health-check failure
+    # - { last: "9.0",   version: "9.1",   tag: "9.1.10-ce.0"  } # docker healthcheck introduced
+    # - { last: "9.1",   version: "9.2",   tag: "9.2.10-ce.0"  }
+    # - { last: "9.2",   version: "9.3",   tag: "9.3.11-ce.0"  }
+    # - { last: "9.3",   version: "9.4",   tag: "9.4.7-ce.0"   }
+    # - { last: "9.4",   version: "9.5",   tag: "9.5.10-ce.0"  }
+    # - { last: "9.5",   version: "10.0",  tag: "10.0.7-ce.0"  }
+    # - { last: "10.0",  version: "10.1",  tag: "10.1.7-ce.0"  }
+    # - { last: "10.1",  version: "10.2",  tag: "10.2.8-ce.0"  }
+    - { last: "10.2",  version: "10.8",  tag: "10.8.4-ce.0"  }
+    # - { last: "10.8",  version: "11.0",  tag: "11.0.0-rc13.ce.0"  }
+    loop_control:
+      loop_var: play_item
+    vars:
+      old_prefix: 'omnibus{{play_item.last}}-'
+      docker_name_prefix: 'omnibus{{play_item.version}}-'
+      gitlab_version: '{{play_item.version}}'
+      gitlab_image_tag: '{{play_item.tag}}'
+      upgrade: true
+    include_role:
+      name: gitlab-omnibus
diff --git a/ansible-playbook/library/docker_volume_clone.py b/ansible-playbook/library/docker_volume_clone.py
new file mode 100644
index 00000000..8dcc4242
--- /dev/null
+++ b/ansible-playbook/library/docker_volume_clone.py
@@ -0,0 +1,147 @@
+#!/usr/bin/python
+#
+# Copyright 2016 Red Hat | Ansible
+# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)
+
+from __future__ import absolute_import, division, print_function
+__metaclass__ = type
+
+
+ANSIBLE_METADATA = {'metadata_version': '1.1',
+                    'status': ['preview'],
+                    'supported_by': 'community'}
+
+
+DOCUMENTATION = '''
+---
+module: docker_volume_clone
+
+short_description: Clone a docker volume
+
+version_added: "2.5.0"
+
+description:
+     - Clones one docker named volume (or host directory)
+       to another docker named volume (or host directory)
+
+options:
+  src:
+    description:
+      - A volume name or host directory
+    required: true
+  dest:
+    description:
+      - A volume name or host directory
+    required: true
+
+extends_documentation_fragment:
+    - docker
+
+requirements:
+  - "python >= 2.6"
+  - "docker-py >= 1.7.0"
+  - "Docker API >= 1.20"
+
+author:
+  - Andrew Cooper (me@andrewcooper.me)
+
+'''
+
+EXAMPLES = '''
+
+- name: Clone one volume into another
+  docker_volume_clone:
+    src: volume1
+    dest: volume2
+
+- name: Mirror a host directory into a volume
+  docker_volume_clone:
+    src: /path/to/host/directory
+    dest: volume2
+'''
+
+RETURN = '''
+'''
+
+try:
+    import docker
+    from docker import utils
+except ImportError:
+    # missing docker-py handled in docker_common
+    pass
+
+from ansible.module_utils.docker_common import AnsibleDockerClient, DockerBaseClass
+
+
+class VolumeManager(DockerBaseClass):
+
+    def __init__(self, client):
+
+        super(VolumeManager, self).__init__()
+
+        self.client = client
+        self.hlclient = docker.DockerClient(**client._connect_params)
+
+        self.src = self.client.module.params.get('src')
+        self.dest = self.client.module.params.get('dest')
+        self.log("Cloning volume %s to %s" % (self.src, self.dest))
+        self.results = {}
+
+        # self.create_rsync_image()
+        self.clone_volume()
+
+    def create_rsync_image(self):
+        import StringIO
+        dockerfile = StringIO.StringIO("""
+            FROM alpine:latest
+            RUN apk add --no-cache rsync
+            ENTRYPOINT ["/usr/bin/rsync"]
+            """)
+        self.rsync = self.hlclient.images.build(
+            fileobj=dockerfile,
+            tag='ansibleutils/rsync:latest'
+        )
+
+    def clone_volume(self):
+        cmd = "apk add --no-cache rsync && /usr/bin/rsync --archive --del /from/ /to/"
+        stdout = ''
+        try:
+            stdout = self.hlclient.containers.run(
+                image='alpine:latest',
+                command=['/bin/ash', '-c', cmd],
+                auto_remove=True,
+                stdout=True,
+                stderr=True,
+                volumes={
+                    self.src: {'bind': '/from', 'mode': 'ro'},
+                    self.dest: {'bind': '/to', 'mode': 'rw'}
+                }
+            )
+            self.results['rc'] = 0
+            self.results['changed'] = True
+        except (docker.errors.ContainerError,
+                docker.errors.ImageNotFound,
+                docker.errors.APIError) as err:
+            self.results['rc'] = 1
+            self.results['failed'] = True
+            self.results['msg'] = str(err)
+        finally:
+            self.results['stdout'] = stdout
+
+
+def main():
+    argument_spec = dict(
+        src=dict(type='str', required=True),
+        dest=dict(type='str', required=True),
+    )
+
+    client = AnsibleDockerClient(
+        argument_spec=argument_spec
+    )
+
+    cm = VolumeManager(client)
+    client.module.exit_json(**cm.results)
+
+
+if __name__ == '__main__':
+    main()
diff --git a/roles/docker-gitlab/defaults/main.yml b/roles/docker-gitlab/defaults/main.yml
index 5e14d572..1dda01c1 100644
--- a/roles/docker-gitlab/defaults/main.yml
+++ b/roles/docker-gitlab/defaults/main.yml
@@ -18,17 +18,19 @@ gitlab_db_user: novatech
 gitlab_image_repo: 'https://github.com/novatechweb/docker-gitlab.git'
 gitlab_image_name: '{{ docker_registry_username }}/gitlab'
 gitlab_dv_image_name: '{{ docker_registry_username }}/gitlab'
-gitlab_db_image_name: '{{ docker_registry_username }}/postgres'
-redis_image_name: '{{ docker_registry_username }}/redis'
+gitlab_db_image_name: 'postgres'
+gitlab_db_image_tag: '9.4'
+redis_image_name: 'redis'
+redis_image_tag: '3.0'
 
 # the name of the gitlab container
 gitlab_container_name: '{{ docker_name_prefix }}gitlab'
 
 # the name of the redis container for gitlab
-gitlab_redis_container_name: '{{ docker_name_prefix }}gitlab_redis'
+gitlab_redis_container_name: '{{ docker_name_prefix }}gitlab-redis'
 
 # the name of the postgres container for gitlab
-gitlab_db_container_name: '{{ docker_name_prefix }}gitlab_db'
+gitlab_db_container_name: '{{ docker_name_prefix }}gitlab-db'
 
 # the name of the data-volume used by the container
 gitlab_dv_name: '{{ docker_name_prefix }}gitlab_DV'
diff --git a/roles/docker-gitlab/tasks/main.yml b/roles/docker-gitlab/tasks/main.yml
index 4b5912f2..9b474842 100644
--- a/roles/docker-gitlab/tasks/main.yml
+++ b/roles/docker-gitlab/tasks/main.yml
@@ -87,14 +87,6 @@
     path: '{{ docker_projects_dir }}/docker-gitlab'
     force: "{{ docker_image_force_build }}"
 
-# Data volume image is now the same as the container image
-#- name: build image
-#  docker_image:
-#    image_name: '{{ gitlab_dv_image_name }}'
-#    image_tag: '{{ docker_image_tag }}'
-#    dockerfile_dir: '{{ docker_projects_dir }}/docker-gitlab'
-#    force: "{{ docker_image_force_build }}"
-
 # *****************************************************************************
 # Create the data volumes
 
@@ -106,23 +98,6 @@
   docker_volume:
     name: '{{ gitlab_db_dv_name }}'
 
-- name: stop prev container (postgres)
-  docker_container:
-    image: '{{ gitlab_db_image_name }}'
-    name: '{{ gitlab_db_container_name }}'
-    state: stopped
-
-- name: initial populate (postgres)
-  docker_db_init:
-    image_name: '{{ gitlab_db_image_name }}'
-    image_tag: '{{ docker_image_tag }}'
-    container_name: '{{ gitlab_db_dv_name }}_init_db'
-    data_volume_container_name: '{{ gitlab_db_dv_name }}'
-    data_volume_dir: '{{ docker_projects_dir }}/docker-gitlab/postgres/'
-    database_name: gitlabhq_production
-    database_user: '{{ gitlab_db_user }}'
-    database_password: '{{ gitlab_db_password | quote }}'
-
 # *****************************************************************************
 # Start the data container running
 
@@ -131,7 +106,7 @@
     name: '{{ gitlab_redis_container_name }}'
     detach: true
     restart_policy: '{{ docker_restart_policy }}'
-    image: '{{ redis_image_name }}:{{ docker_image_tag }}'
+    image: '{{ redis_image_name }}:{{ redis_image_tag }}'
     networks:
       - name: '{{ docker_network_frontend }}'
 
@@ -140,10 +115,25 @@
     name: '{{ gitlab_db_container_name }}'
     detach: true
     restart_policy: '{{ docker_restart_policy }}'
-    volumes_from: '{{ gitlab_db_dv_name }}'
-    image: '{{ gitlab_db_image_name }}:{{ docker_image_tag }}'
+    volumes:
+    - '{{ gitlab_db_dv_name }}:/var/lib/postgresql/data'
+    image: '{{ gitlab_db_image_name }}:{{ gitlab_db_image_tag }}'
     networks:
-      - name: '{{ docker_network_frontend }}'
+    - name: '{{ docker_network_frontend }}'
+    env:
+      POSTGRES_DB: "gitlabhq_production"
+      POSTGRES_USER: "{{ gitlab_db_user }}"
+      POSTGRES_PASSWORD: "{{ gitlab_db_password | quote }}"
+
+- name: Wait for container (postgres)
+  command: >
+    docker exec --user postgres
+    {{ gitlab_db_container_name }}
+    psql -l
+  register: output
+  retries: 10
+  delay: 3
+  until: output.rc == 0
 
 - name: start container (gitlab)
   docker_container:
@@ -154,29 +144,35 @@
     ports: '{{ gitlab_port_args }}'
     networks:
       - name: '{{ docker_network_frontend }}'
-    volumes-from:
-      - '{{ openssl_dv_name }}'
-      - '{{ gitlab_dv_name }}'
+    volumes:
+      - '{{ openssl_dv_name }}:/etc/ssl/private:ro'
+      - '{{ gitlab_dv_name }}:/home/git/data'
+      - '{{ gitlab_docker_backup_dir }}:/home/git/backups'
     env:
-      - GITLAB_HOST={{ gitlab_hostname }}
-      - GITLAB_SSH_HOST={{ gitlab_hostname }}
-      - DB_USER={{ gitlab_db_user }}
-      - DB_PASS={{ gitlab_db_password | quote }}
-      - SMTP_HOST={{ exim4_hostname }}
-      - SMTP_PASS={{ gitlab_email_password | quote }}
-      - LDAP_PASS={{ ldap_proxyagent_password | quote }}
-      - GITLAB_ROOT_PASSWORD={{ gitlab_root_password | quote }}
-      - GITLAB_SECRETS_DB_KEY_BASE={{ gitlab_secrets_db_key_base | quote }}
-    env-file: '{{ docker_projects_dir }}/docker-gitlab/gitlab.env.list'
+      DEBUG_ENTRYPOINT: 1
+      GITLAB_TIMEZONE: "America\\/Chicago"
+      GITLAB_HOST: "{{ gitlab_hostname }}"
+      GITLAB_SSH_HOST: "{{ gitlab_hostname }}"
+      DB_HOST: "{{ gitlab_db_container_name }}"
+      DB_USER: "{{ gitlab_db_user }}"
+      DB_PASS: "{{ gitlab_db_password | quote }}"
+      REDIS_HOST: "{{ gitlab_redis_container_name }}"
+      SMTP_HOST: "{{ exim4_hostname }}"
+      SMTP_PASS: "{{ gitlab_email_password | quote }}"
+      LDAP_PASS: "{{ openldap_proxyagent_password | quote }}"
+      GITLAB_ROOT_PASSWORD: "{{ gitlab_root_password | quote }}"
+      GITLAB_SECRETS_DB_KEY_BASE: "{{ gitlab_secrets_db_key_base | quote }}"
+      SSL_DHPARAM_PATH: /etc/ssl/private/dhparam.pem
+    env_file: '{{ docker_projects_dir }}/docker-gitlab/gitlab.env.list'
     image: '{{ gitlab_image_name }}:{{ docker_image_tag }}'
 
 - name: Wait for gitlab to be fully running
-  docker_health:
-    name: '{{ gitlab_container_name }}'
+  uri:
+    url: 'http://{{ gitlab_hostname }}/users/sign_in'
   register: health
   retries: 60
   delay: 5
-  until: health.Health.Status == "healthy"
+  until: health.status == 200
 
 # *****************************************************************************
 # restore?
diff --git a/roles/docker-gitlab/tasks/restore.yml b/roles/docker-gitlab/tasks/restore.yml
index fc4cc59c..c085a1d6 100644
--- a/roles/docker-gitlab/tasks/restore.yml
+++ b/roles/docker-gitlab/tasks/restore.yml
@@ -5,8 +5,9 @@
 # Get data from tape
 
 - name: find files
-  files_in_dir:
+  find:
     path: '{{ gitlab_docker_restore_dir }}'
+    file_type: any
   register: gitlab_backup
 
 - name: data from tape
@@ -16,11 +17,12 @@
     fileset: '{{ bacula_fileset }}'
     dest: '{{ bacula_dest }}'
     path_to_restore: '{{ gitlab_docker_backup_dir }}'
-  when: gitlab_backup.file_list == []
+  when: gitlab_backup.matched == 0
 
 - name: find files
-  files_in_dir:
+  find:
     path: '{{ gitlab_docker_restore_dir }}'
+    file_type: any
   register: gitlab_backup
 
 # - name: File permissions
@@ -35,19 +37,43 @@
 # *****************************************************************************
 # restore the gitlap backup
 
+- name: Copy backup files to container
+  copy:
+    remote_src: yes
+    src: '{{ item.path }}'
+    dest: '{{ gitlab_docker_backup_dir }}/'
+    owner: root
+    group: root
+    mode: 'u=rwx,g=rwx,o=rwx'
+  loop: "{{ gitlab_backup.files }}"
+
+- name: shut down gitlab services for restoration
+  command: >
+    docker exec {{ gitlab_container_name }}
+    supervisorctl stop {{ item }}
+  loop:
+  - unicorn
+  - sidekiq
+
 - name: gitlab restore script
-  command: '{{ docker_projects_dir }}/docker-gitlab/gitlab.sh restore'
-  args:
-    chdir: '{{ docker_restore_config_base_dir }}/{{ gitlab_dv_name }}/'
-  when: gitlab_backup.file_list != []
+  command: >
+    docker exec -u git {{ gitlab_container_name }}
+    bundle exec rake gitlab:backup:restore force=yes BACKUP="{{backup_file}}"
+  vars:
+    backup_file: '{{ (gitlab_backup.files | first)["path"] | basename | replace("_gitlab_backup.tar","") }}'
+
+- name: restart gitlab services
+  command: >
+    docker exec {{ gitlab_container_name }}
+    supervisorctl start all
 
 - name: Wait for gitlab to be fully running
-  docker_health:
-    name: '{{ gitlab_container_name }}'
+  uri:
+    url: 'http://{{ gitlab_hostname }}/users/sign_in'
   register: health
   retries: 60
   delay: 5
-  until: health.Health.Status == "healthy"
+  until: health.status == 200
 
 # *****************************************************************************
 # cleanup
diff --git a/roles/gitlab-omnibus/defaults/main.yml b/roles/gitlab-omnibus/defaults/main.yml
new file mode 100644
index 00000000..a509d4ee
--- /dev/null
+++ b/roles/gitlab-omnibus/defaults/main.yml
@@ -0,0 +1,50 @@
+---
+
+gitlab_version: "10.1.7"
+
+# The hostname passed as an envirnment variable into the container
+gitlab_ip_addr: '127.0.0.1'
+gitlab_hostname: git.example.com
+gitlab_port_args: 
+    - 80
+    - 443
+    - 22
+
+# database usernames and passwords
+gitlab_db_user: novatech
+
+# must pass in the following variables
+# gitlab_db_password: ''
+
+# the name of the image being duilt and used for the container
+gitlab_image_tag: "{{gitlab_version}}-ce.0"
+gitlab_image_name: 'gitlab/gitlab-ce:{{gitlab_image_tag}}'
+# gitlab_dv_image_name: '{{ docker_registry_username }}/gitlab'
+# gitlab_db_image_name: '{{ docker_registry_username }}/postgres'
+# redis_image_name: '{{ docker_registry_username }}/redis'
+
+# the name of the gitlab container
+gitlab_container_name: '{{ docker_name_prefix }}gitlab'
+
+# the name of the redis container for gitlab
+# gitlab_redis_container_name: '{{ docker_name_prefix }}gitlab_redis'
+
+# the name of the postgres container for gitlab
+# gitlab_db_container_name: '{{ docker_name_prefix }}gitlab_db'
+
+# the name of the config-volume used by the container
+gitlab_cv_name: '{{ docker_name_prefix }}gitlab_CV'
+
+# the name of the data-volume used by the container
+gitlab_dv_name: '{{ docker_name_prefix }}gitlab_DV'
+
+# the name of the data-volume used by the postgres container
+# gitlab_db_dv_name: '{{ docker_name_prefix }}gitlab_db_DV'
+
+# restore directories to temporarly store data being restored into docker containers
+gitlab_docker_backup_dir: '{{ docker_backup_dir }}/GIT'
+gitlab_docker_restore_dir: '{{ bacula_dest }}{{ gitlab_docker_backup_dir }}'
+
+# Network names
+docker_network_frontend: 'frontend'
+gitlab_config_dir: '{{ docker_restore_config_base_dir }}/{{ gitlab_dv_name }}'
diff --git a/roles/gitlab-omnibus/tasks/main.yml b/roles/gitlab-omnibus/tasks/main.yml
new file mode 100644
index 00000000..db6cb7bd
--- /dev/null
+++ b/roles/gitlab-omnibus/tasks/main.yml
@@ -0,0 +1,166 @@
+---
+# file: roles/docker-gitlab/tasks/main.yaml
+
+- assert:
+    that:
+    - gitlab_db_password is defined
+
+# *****************************************************************************
+# Setup the directory where the backup and restore is to take place
+
+# - name: restore dir
+#   file:
+#     state: directory
+#     path: '{{ gitlab_docker_restore_dir }}'
+#     owner: root
+#     group: tape
+#     mode: 'u=rwx,g=rwx,o=rx'
+#     recurse: no
+#     setype: svirt_sandbox_file_t
+
+- name: docker_container.conf dir
+  file:
+    state: directory
+    path: '{{ gitlab_config_dir }}'
+    owner: root
+    group: root
+    mode: 'u=rwx,g=rx,o=rx'
+    recurse: no
+
+# *****************************************************************************
+# backup script part
+
+# - name: Assemble dir for backup scripts
+#   file:
+#     path: /usr/libexec/bacula/backup-scripts
+#     state: directory
+
+# - name: before_backup script part
+#   template:
+#     src: before_backup.j2
+#     dest: /usr/libexec/bacula/backup-scripts/55.before_backup.gitlab
+
+# - name: after_backup script part
+#   template:
+#     src: after_backup.j2
+#     dest: /usr/libexec/bacula/backup-scripts/55.after_backup.gitlab
+
+# *****************************************************************************
+# update the Docker restore config
+
+# contains the database username and password
+- name: make gitlab.rb
+  template:
+    src: gitlab.rb-{{gitlab_version}}.j2
+    dest: '{{ gitlab_config_dir }}/gitlab.rb'
+    backup: yes
+    owner: root
+    group: root
+    mode: 'u=rw,g=r,o='
+- name: exists - state file
+  stat:
+    path: '{{ gitlab_config_dir }}/restore.date.txt'
+    get_checksum: False
+    get_md5: False
+  register: st_gitlab_restore
+
+# *****************************************************************************
+# upgrade?
+
+- include_tasks: upgrade.yml
+  when:
+  - upgrade
+
+# *****************************************************************************
+# Create the data volumes
+
+- name: config-volume container (gitlab)
+  docker_volume:
+    name: '{{ gitlab_cv_name }}'
+
+
+- name: data-volume container (gitlab)
+  docker_volume:
+    name: '{{ gitlab_dv_name }}'
+
+# *****************************************************************************
+# Create the gitlab container
+
+- name: create container (gitlab)
+  docker_container:
+    name: '{{ gitlab_container_name }}'
+    detach: true
+    restart_policy: '{{ docker_restart_policy }}'
+    hostname: '{{ gitlab_hostname }}'
+    ports: '{{ gitlab_port_args }}'
+    networks:
+      - name: '{{ docker_network_frontend }}'
+    volumes:
+      - '{{ openssl_dv_name }}:/etc/ssl/private:z'
+      - '{{ gitlab_cv_name }}:/etc/gitlab:z'
+      - '{{ gitlab_dv_name }}:/var/opt/gitlab:z'
+      - '{{ gitlab_docker_backup_dir }}:/mnt/backups:z'
+    image: '{{ gitlab_image_name }}'
+    state: present
+
+- name: Copy config into container
+  command: >
+    docker cp
+    '{{ gitlab_config_dir }}/gitlab.rb'
+    '{{ gitlab_container_name }}:/etc/gitlab/gitlab.rb'
+
+- name: start container (gitlab)
+  docker_container:
+    name: '{{ gitlab_container_name }}'
+    state: started
+
+- name: Wait for gitlab to be fully running
+  uri:
+    url: 'https://{{ gitlab_hostname }}/users/sign_in'
+  register: health
+  retries: 10
+  delay: 30
+  until: health is success
+  when: gitlab_version is version('9.1', '<')
+
+- name: Wait for a container to become healthy
+  docker_health:
+    name: "{{gitlab_container_name}}"
+  register: health
+  retries: 10
+  delay: 30
+  until: health.Health.Status == "healthy"
+  when: gitlab_version is version('9.1', '>=')
+
+# *****************************************************************************
+# restore?
+
+- include_tasks: restore.yml
+  when: st_gitlab_restore.stat.exists == False
+
+# *****************************************************************************
+# final maintenance
+
+- name: reconfigure gitlab for updated configuration
+  command: >
+    docker exec -t {{ gitlab_container_name }} gitlab-ctl reconfigure
+  register: reconfigure
+  retries: 10
+  delay: 30
+  until: reconfigure is success
+
+- name: ensure all migrations are complete
+  command: >
+    docker exec -t {{ gitlab_container_name }} gitlab-rake db:migrate
+  register: migrate
+  retries: 10
+  delay: 30
+  until: migrate is success
+
+- name: run a diagnostic check over the application
+  command: >
+    docker exec -t {{ gitlab_container_name }} gitlab-rake gitlab:check
+  register: check
+  retries: 10
+  delay: 30
+  until: check is success
diff --git a/roles/gitlab-omnibus/tasks/restore.yml b/roles/gitlab-omnibus/tasks/restore.yml
new file mode 100644
index 00000000..d773b25f
--- /dev/null
+++ b/roles/gitlab-omnibus/tasks/restore.yml
@@ -0,0 +1,125 @@
+---
+# file: roles/docker-gitlab/tasks/restore.yaml
+
+# *****************************************************************************
+# Get data from tape
+
+- name: find files
+  find:
+    path: '{{ gitlab_docker_restore_dir }}'
+    file_type: any
+  register: gitlab_backup
+
+- name: data from tape
+  bacula:
+    command: restore
+    storage: '{{ bacula_storage }}'
+    fileset: '{{ bacula_fileset }}'
+    dest: '{{ bacula_dest }}'
+    path_to_restore: '{{ gitlab_docker_backup_dir }}'
+  when: gitlab_backup.matched == 0
+
+- name: find files
+  find:
+    path: '{{ gitlab_docker_restore_dir }}'
+    file_type: any
+    follow: yes
+  register: gitlab_backup
+
+- name: File permissions
+  file:
+    path: '{{ gitlab_docker_restore_dir }}/{{ item }}'
+    state: touch
+    owner: root
+    group: root
+    mode: 'u=rwx,g=rwx,o='
+  with_items: '{{ gitlab_backup.file_list | default([]) }}'
+
+# *****************************************************************************
+# restore the gitlab backup
+
+- name: Copy backup files to container
+  copy:
+    remote_src: yes
+    src: '{{ item.path }}'
+    dest: '{{ gitlab_docker_backup_dir }}/'
+    owner: root
+    group: root
+    mode: 'u=rwx,g=rwx,o=rwx'
+  loop: "{{ gitlab_backup.files }}"
+
+- name: shut down gitlab services for restoration
+  command: >
+    docker exec -t {{ gitlab_container_name }} gitlab-ctl stop {{ item }}
+  loop:
+  - unicorn
+  - sidekiq
+
+- name: restore gitlab secrets
+  block:
+  - name: find gitlab secrets archive
+    find:
+      path: '{{ gitlab_docker_backup_dir }}'
+      pattern: "*_{{gitlab_version}}_gitlab_etc.tgz"
+    register: backup_files
+  - set_fact:
+      backup_file: "/mnt/backups/{{backup_files.files[0]['path'] | basename}}"
+    when: backup_files.matched > 0
+  - command: >
+      docker exec -t {{ gitlab_container_name }}
+      /bin/sh -c 'tar vxzf "{{backup_file}}" -C /' 
+    when: backup_files.matched > 0
+
+- name: restore gitlab data
+  block:
+  - name: find gitlab data archive
+    find:
+      path: '{{ gitlab_docker_backup_dir }}'
+      pattern: "*_{{gitlab_version}}_gitlab_backup.tar"
+    register: backup_files
+  - set_fact:
+      backup_file: "/mnt/backups/{{backup_files.files[0]['path'] | basename | replace('_gitlab_backup.tar','')}}"
+    when: backup_files.matched > 0
+  - command: >
+      docker exec -t {{ gitlab_container_name }}
+      gitlab-rake gitlab:backup:restore force=yes BACKUP="{{backup_file}}"
+    when: backup_files.matched > 0
+
+- name: reconfigure gitlab for updated configuration
+  command: >
+    docker exec -t {{ gitlab_container_name }} gitlab-ctl reconfigure
+
+- name: restart gitlab services
+  command: >
+    docker exec -t {{ gitlab_container_name }} gitlab-ctl start
+  register: result
+  failed_when: ( result.rc not in [ 0, 127 ] )
+
+- name: Wait for gitlab to be fully running
+  uri:
+    url: 'http://{{ gitlab_hostname }}/users/sign_in'
+  register: health
+  retries: 60
+  delay: 5
+  until: health.status == 200
+
+- name: Set root user password in restored database
+  command: >
+    docker exec -t {{ gitlab_container_name }} 
+    gitlab-rails runner 
+      'user=User.where(id: 1).first;
+       user.password="{{ gitlab_root_password }}";
+       user.password_confirmation="{{ gitlab_root_password }}";
+       user.save!'
+
+# *****************************************************************************
+# cleanup
+
+- name: Remove files
+  file:
+    path: '{{ gitlab_docker_restore_dir }}'
+    state: absent
+
+- name: State file
+  shell: 'date --rfc-3339=seconds > {{ gitlab_config_dir }}/restore.date.txt'
+  when: st_gitlab_restore.stat.exists == False
diff --git a/roles/gitlab-omnibus/tasks/upgrade.yml b/roles/gitlab-omnibus/tasks/upgrade.yml
new file mode 100644
index 00000000..f606f7c7
--- /dev/null
+++ b/roles/gitlab-omnibus/tasks/upgrade.yml
@@ -0,0 +1,30 @@
+---
+
+- assert:
+    that: old_prefix is defined
+
+- name: Shut down old version
+  docker_container: 
+    name: '{{ old_prefix }}{{ item }}'
+    state: stopped
+  loop:
+  - gitlab
+
+- name: Clone volumes
+  docker_volume_clone:
+    src: '{{old_prefix}}{{item}}'
+    dest: '{{docker_name_prefix}}{{item}}'
+  loop:
+  - gitlab_CV
+  - gitlab_DV
+
+- name: State file
+  shell: 'date --rfc-3339=seconds > {{ docker_restore_config_base_dir }}/{{ gitlab_dv_name }}/restore.date.txt'
+  when: st_gitlab_restore.stat.exists == False
+
+- name: exists - state file
+  stat:
+    path: '{{ docker_restore_config_base_dir }}/{{ gitlab_dv_name }}/restore.date.txt'
+    get_checksum: False
+    get_md5: False
+  register: st_gitlab_restore
diff --git a/roles/gitlab-omnibus/templates/after_backup.j2 b/roles/gitlab-omnibus/templates/after_backup.j2
new file mode 100644
index 00000000..85b103f0
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/after_backup.j2
@@ -0,0 +1,6 @@
+{% if gitlab_docker_backup_dir is defined %}
+
+# *****************************************************************************
+# Clean up git
+docker run --rm -v {{ docker_backup_dir }}:/tmp/import_export:z debian:latest bash -c "rm -rf /tmp/import_export/GIT"
+{% endif %}
diff --git a/roles/gitlab-omnibus/templates/before_backup.j2 b/roles/gitlab-omnibus/templates/before_backup.j2
new file mode 100644
index 00000000..7b29c1f6
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/before_backup.j2
@@ -0,0 +1,10 @@
+{% if gitlab_docker_backup_dir is defined %}
+
+# *****************************************************************************
+# Backup gitlab
+docker run --rm -v {{ docker_backup_dir }}:/tmp/import_export:z debian:latest bash -c "rm -rf /tmp/import_export/GIT"
+mkdir -p -m u=rwx,g=rwx,o= {{ gitlab_docker_backup_dir }}
+docker exec -t {{ gitlab_container_name }} gitlab_rake gitlab:backup:create
+docker exec -t {{ gitlab_container_name }} /bin/sh -c \
+    'umask 0077; tar czf /mnt/backups/$(date "+%s_%Y_%m_%d_{{gitlab_version}}_gitlab_etc.tgz") -C / etc/gitlab'
+{% endif %}
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-10.0.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-10.0.j2
new file mode 100644
index 00000000..6288d08c
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-10.0.j2
@@ -0,0 +1,63 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    encryption: 'plain' # "start_tls" or "simple_tls" or "plain"
+    verify_certificates: true
+    ca_file: ''
+    ssl_version: ''
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-10.1.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-10.1.j2
new file mode 100644
index 00000000..6288d08c
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-10.1.j2
@@ -0,0 +1,63 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    encryption: 'plain' # "start_tls" or "simple_tls" or "plain"
+    verify_certificates: true
+    ca_file: ''
+    ssl_version: ''
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-10.2.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-10.2.j2
new file mode 100644
index 00000000..6288d08c
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-10.2.j2
@@ -0,0 +1,63 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    encryption: 'plain' # "start_tls" or "simple_tls" or "plain"
+    verify_certificates: true
+    ca_file: ''
+    ssl_version: ''
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-10.8.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-10.8.j2
new file mode 100644
index 00000000..6288d08c
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-10.8.j2
@@ -0,0 +1,63 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    encryption: 'plain' # "start_tls" or "simple_tls" or "plain"
+    verify_certificates: true
+    ca_file: ''
+    ssl_version: ''
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-8.0.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-8.0.j2
new file mode 100644
index 00000000..53c7b06f
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-8.0.j2
@@ -0,0 +1,60 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    method: 'plain' # "tls" or "ssl" or "plain"
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-8.1.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-8.1.j2
new file mode 100644
index 00000000..53c7b06f
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-8.1.j2
@@ -0,0 +1,60 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    method: 'plain' # "tls" or "ssl" or "plain"
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-8.10.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-8.10.j2
new file mode 100644
index 00000000..53c7b06f
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-8.10.j2
@@ -0,0 +1,60 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    method: 'plain' # "tls" or "ssl" or "plain"
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-8.11.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-8.11.j2
new file mode 100644
index 00000000..53c7b06f
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-8.11.j2
@@ -0,0 +1,60 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    method: 'plain' # "tls" or "ssl" or "plain"
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-8.12.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-8.12.j2
new file mode 100644
index 00000000..53c7b06f
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-8.12.j2
@@ -0,0 +1,60 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    method: 'plain' # "tls" or "ssl" or "plain"
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-8.13.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-8.13.j2
new file mode 100644
index 00000000..53c7b06f
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-8.13.j2
@@ -0,0 +1,60 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    method: 'plain' # "tls" or "ssl" or "plain"
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-8.14.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-8.14.j2
new file mode 100644
index 00000000..53c7b06f
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-8.14.j2
@@ -0,0 +1,60 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    method: 'plain' # "tls" or "ssl" or "plain"
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-8.15.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-8.15.j2
new file mode 100644
index 00000000..53c7b06f
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-8.15.j2
@@ -0,0 +1,60 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    method: 'plain' # "tls" or "ssl" or "plain"
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-8.16.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-8.16.j2
new file mode 100644
index 00000000..53c7b06f
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-8.16.j2
@@ -0,0 +1,60 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    method: 'plain' # "tls" or "ssl" or "plain"
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-8.17.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-8.17.j2
new file mode 100644
index 00000000..53c7b06f
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-8.17.j2
@@ -0,0 +1,60 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    method: 'plain' # "tls" or "ssl" or "plain"
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-8.2.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-8.2.j2
new file mode 100644
index 00000000..53c7b06f
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-8.2.j2
@@ -0,0 +1,60 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    method: 'plain' # "tls" or "ssl" or "plain"
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-8.3.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-8.3.j2
new file mode 100644
index 00000000..53c7b06f
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-8.3.j2
@@ -0,0 +1,60 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    method: 'plain' # "tls" or "ssl" or "plain"
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-8.4.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-8.4.j2
new file mode 100644
index 00000000..53c7b06f
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-8.4.j2
@@ -0,0 +1,60 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    method: 'plain' # "tls" or "ssl" or "plain"
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-8.5.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-8.5.j2
new file mode 100644
index 00000000..53c7b06f
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-8.5.j2
@@ -0,0 +1,60 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    method: 'plain' # "tls" or "ssl" or "plain"
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-8.6.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-8.6.j2
new file mode 100644
index 00000000..53c7b06f
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-8.6.j2
@@ -0,0 +1,60 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    method: 'plain' # "tls" or "ssl" or "plain"
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-8.7.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-8.7.j2
new file mode 100644
index 00000000..53c7b06f
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-8.7.j2
@@ -0,0 +1,60 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    method: 'plain' # "tls" or "ssl" or "plain"
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-8.8.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-8.8.j2
new file mode 100644
index 00000000..53c7b06f
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-8.8.j2
@@ -0,0 +1,60 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    method: 'plain' # "tls" or "ssl" or "plain"
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-8.9.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-8.9.j2
new file mode 100644
index 00000000..53c7b06f
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-8.9.j2
@@ -0,0 +1,60 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    method: 'plain' # "tls" or "ssl" or "plain"
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-9.0.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-9.0.j2
new file mode 100644
index 00000000..6288d08c
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-9.0.j2
@@ -0,0 +1,63 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    encryption: 'plain' # "start_tls" or "simple_tls" or "plain"
+    verify_certificates: true
+    ca_file: ''
+    ssl_version: ''
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-9.1.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-9.1.j2
new file mode 100644
index 00000000..6288d08c
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-9.1.j2
@@ -0,0 +1,63 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    encryption: 'plain' # "start_tls" or "simple_tls" or "plain"
+    verify_certificates: true
+    ca_file: ''
+    ssl_version: ''
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-9.2.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-9.2.j2
new file mode 100644
index 00000000..6288d08c
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-9.2.j2
@@ -0,0 +1,63 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    encryption: 'plain' # "start_tls" or "simple_tls" or "plain"
+    verify_certificates: true
+    ca_file: ''
+    ssl_version: ''
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-9.3.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-9.3.j2
new file mode 100644
index 00000000..6288d08c
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-9.3.j2
@@ -0,0 +1,63 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    encryption: 'plain' # "start_tls" or "simple_tls" or "plain"
+    verify_certificates: true
+    ca_file: ''
+    ssl_version: ''
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-9.4.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-9.4.j2
new file mode 100644
index 00000000..6288d08c
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-9.4.j2
@@ -0,0 +1,63 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    encryption: 'plain' # "start_tls" or "simple_tls" or "plain"
+    verify_certificates: true
+    ca_file: ''
+    ssl_version: ''
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-omnibus/templates/gitlab.rb-9.5.j2 b/roles/gitlab-omnibus/templates/gitlab.rb-9.5.j2
new file mode 100644
index 00000000..6288d08c
--- /dev/null
+++ b/roles/gitlab-omnibus/templates/gitlab.rb-9.5.j2
@@ -0,0 +1,63 @@
+external_url 'https://{{ gitlab_hostname }}'
+gitlab_rails['gitlab_ssh_host'] = '{{ gitlab_hostname }}'
+gitlab_rails['time_zone'] = 'America/Chicago'
+gitlab_rails['gitlab_email_enabled'] = true
+gitlab_rails['gitlab_email_from'] = 'gitlab@novatech-llc.com'
+gitlab_rails['gitlab_email_display_name'] = 'GitLab'
+gitlab_rails['gitlab_email_reply_to'] = 'noreply@novatech-llc.com'
+gitlab_rails['gitlab_default_can_create_group'] = true
+gitlab_rails['gitlab_username_changing_enabled'] = true
+gitlab_rails['gitlab_default_projects_features_issues'] = true
+gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
+gitlab_rails['gitlab_default_projects_features_wiki'] = false
+gitlab_rails['gitlab_default_projects_features_snippets'] = true
+gitlab_rails['gravatar_plain_url'] = 'http://cdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+gitlab_rails['gravatar_ssl_url'] = 'https://seccdn.libravatar.org/avatar/%{hash}?s=%{size}&d=identicon'
+
+gitlab_rails['ldap_enabled'] = true
+gitlab_rails['ldap_servers'] = YAML.load <<-'EOS' # remember to close this block with 'EOS' below
+  main: # 'main' is the GitLab 'provider ID' of this LDAP server
+    label: 'NovaTech'
+    host: '{{ openldap_hostname }}'
+    port: 389
+    uid: 'uid'
+    bind_dn: 'cn=proxyagent,dc=novatech'
+    password: '{{ gitlab_email_password }}'
+    encryption: 'plain' # "start_tls" or "simple_tls" or "plain"
+    verify_certificates: true
+    ca_file: ''
+    ssl_version: ''
+    active_directory: false
+    allow_username_or_email_login: true
+    block_auto_created_users: false
+    base: 'ou=user,dc=novatech'
+    user_filter: '(employeeType=gitlab)'
+    attributes:
+      username: ['uid', 'userid', 'sAMAccountName']
+      email:    ['mail', 'email', 'userPrincipalName']
+      name:       'cn'
+      first_name: 'givenName'
+      last_name:  'sn'
+EOS
+
+gitlab_rails['backup_path'] = "/mnt/backups"
+gitlab_rails['backup_archive_permissions'] = 0644
+gitlab_rails['backup_pg_schema'] = 'public'
+gitlab_rails['backup_keep_time'] = 604800
+
+gitlab_rails['smtp_enable'] = true
+gitlab_rails['smtp_address'] = "{{ exim4_hostname }}"
+gitlab_rails['smtp_port'] = 465
+gitlab_rails['smtp_user_name'] = "gitlab"
+gitlab_rails['smtp_password'] = "{{ gitlab_email_password }}"
+gitlab_rails['smtp_domain'] = "novatech-llc.com"
+gitlab_rails['smtp_authentication'] = "login"
+gitlab_rails['smtp_enable_starttls_auto'] = true
+gitlab_rails['smtp_tls'] = true
+
+nginx['enable'] = true
+nginx['redirect_http_to_https'] = true
+nginx['ssl_certificate'] = "/etc/ssl/private/nginx.crt"
+nginx['ssl_certificate_key'] = "/etc/ssl/private/nginx.key"
+nginx['ssl_dhparam'] = "/etc/ssl/private/dhparam.pem" # Path to dhparams.pem, eg. /etc/ssl/private/dhparams.pem
+nginx['listen_port'] = 443
diff --git a/roles/gitlab-sameersbn-8/defaults/main.yml b/roles/gitlab-sameersbn-8/defaults/main.yml
new file mode 100644
index 00000000..f8963e7f
--- /dev/null
+++ b/roles/gitlab-sameersbn-8/defaults/main.yml
@@ -0,0 +1,48 @@
+---
+
+gitlab_version: "8.0.5"
+
+# The hostname passed as an envirnment variable into the container
+gitlab_ip_addr: '127.0.0.1'
+gitlab_hostname: git.example.com
+gitlab_port_args: 
+    - 80
+    - 443
+    - 22
+
+# database usernames and passwords
+gitlab_db_user: novatech
+
+# must pass in the following variables
+# gitlab_db_password: ''
+
+# the name of the image being duilt and used for the container
+gitlab_image_repo: 'https://github.com/novatechweb/docker-gitlab.git'
+gitlab_image_tag: '{{gitlab_version}}'
+gitlab_image_name: 'sameersbn/gitlab:{{gitlab_image_tag}}'
+gitlab_db_image_name: 'postgres'
+gitlab_db_image_tag: '9.4'
+redis_image_name: 'redis'
+redis_image_tag: '3.0'
+
+# the name of the gitlab container
+gitlab_container_name: '{{ docker_name_prefix }}gitlab'
+
+# the name of the redis container for gitlab
+gitlab_redis_container_name: '{{ docker_name_prefix }}gitlab-redis'
+
+# the name of the postgres container for gitlab
+gitlab_db_container_name: '{{ docker_name_prefix }}gitlab-db'
+
+# the name of the data-volume used by the container
+gitlab_dv_name: '{{ docker_name_prefix }}gitlab_DV'
+
+# the name of the data-volume used by the postgres container
+gitlab_db_dv_name: '{{ docker_name_prefix }}gitlab_db_DV'
+
+# restore directories to temporarly store data being restored into docker containers
+gitlab_docker_backup_dir: '{{ docker_backup_dir }}/GIT'
+gitlab_docker_restore_dir: '{{ bacula_dest }}{{ gitlab_docker_backup_dir }}'
+
+# Network names
+docker_network_frontend: 'frontend'
diff --git a/roles/gitlab-sameersbn-8/files/secrets.yml b/roles/gitlab-sameersbn-8/files/secrets.yml
new file mode 100644
index 00000000..cc5d119d
--- /dev/null
+++ b/roles/gitlab-sameersbn-8/files/secrets.yml
@@ -0,0 +1,12 @@
+production:
+  # db_key_base is used to encrypt for Variables. Ensure that you don't lose it.
+  # If you change or lose this key you will be unable to access variables stored in database.
+  # Make sure the secret is at least 30 characters and all random,
+  # no regular words or you'll be exposed to dictionary attacks.
+  db_key_base: '{{GITLAB_SECRETS_DB_KEY_BASE}}'
+
+development:
+  db_key_base: development
+
+test:
+  db_key_base: test
diff --git a/roles/gitlab-sameersbn-8/tasks/main.yml b/roles/gitlab-sameersbn-8/tasks/main.yml
new file mode 100644
index 00000000..d9d18bd7
--- /dev/null
+++ b/roles/gitlab-sameersbn-8/tasks/main.yml
@@ -0,0 +1,212 @@
+---
+# file: roles/docker-gitlab/tasks/main.yaml
+
+- assert:
+    that:
+    - gitlab_db_password is defined
+
+# *****************************************************************************
+# Setup the directory where the backup and restore is to take place
+
+# - name: restore dir
+#   file:
+#     state: directory
+#     path: '{{ gitlab_docker_restore_dir }}'
+#     owner: root
+#     group: tape
+#     mode: 'u=rwx,g=rwx,o=rx'
+#     recurse: no
+#     setype: svirt_sandbox_file_t
+
+- name: docker_container.conf dir
+  file:
+    state: directory
+    path: '{{ docker_restore_config_base_dir }}/{{ gitlab_dv_name }}'
+    owner: root
+    group: root
+    mode: 'u=rwx,g=rx,o=rx'
+    recurse: no
+
+# *****************************************************************************
+# backup script part
+
+# - name: Assemble dir for backup scripts
+#   file:
+#     path: /usr/libexec/bacula/backup-scripts
+#     state: directory
+
+# - name: before_backup script part
+#   template:
+#     src: before_backup.j2
+#     dest: /usr/libexec/bacula/backup-scripts/55.before_backup.gitlab
+
+# - name: after_backup script part
+#   template:
+#     src: after_backup.j2
+#     dest: /usr/libexec/bacula/backup-scripts/55.after_backup.gitlab
+
+# *****************************************************************************
+# update the Docker restore config
+
+# contains the database username and password
+# - name: make config.sh
+#   template:
+#     src: config.sh.j2
+#     dest: '{{ docker_restore_config_base_dir }}/{{ gitlab_dv_name }}/config.sh'
+#     backup: yes
+#     owner: root
+#     group: tape
+#     mode: 'u=rw,g=r,o='
+
+- name: exists - state file
+  stat:
+    path: '{{ docker_restore_config_base_dir }}/{{ gitlab_dv_name }}/restore.date.txt'
+    get_checksum: False
+    get_md5: False
+  register: st_gitlab_restore
+
+# *****************************************************************************
+# upgrade?
+
+- include_tasks: upgrade.yml
+  when:
+  - upgrade == True
+
+# *****************************************************************************
+# Update or make the image.
+
+- name: Checkout image repo
+  git:
+    repo: '{{ gitlab_image_repo }}'
+    version: master
+    dest: '{{ docker_projects_dir }}/docker-gitlab'
+
+- name: copy env-file
+  command: 'cp --verbose --update --backup=numbered {{ docker_projects_dir }}/docker-gitlab/gitlab.env.list {{ docker_restore_config_base_dir }}/{{ gitlab_dv_name }}'
+
+# - name: copy script
+#   command: 'cp --verbose --update --backup=numbered {{ docker_projects_dir }}/docker-gitlab/gitlab.sh {{ docker_restore_config_base_dir }}/{{ gitlab_dv_name }}'
+
+# - name: build image
+#   docker_image:
+#     name: '{{ gitlab_image_name }}'
+#     tag: '{{ docker_image_tag }}'
+#     path: '{{ docker_projects_dir }}/docker-gitlab'
+#     force: "{{ docker_image_force_build }}"
+
+# *****************************************************************************
+# Create the data volumes
+
+- name: data-volume container (gitlab)
+  docker_volume:
+    name: '{{ gitlab_dv_name }}'
+
+- name: data-volume container (postgres)
+  docker_volume:
+    name: '{{ gitlab_db_dv_name }}'
+
+# *****************************************************************************
+# Start the data container running
+
+- name: start container (redis)
+  docker_container:
+    name: '{{ gitlab_redis_container_name }}'
+    detach: true
+    restart_policy: '{{ docker_restart_policy }}'
+    image: '{{ redis_image_name }}:{{ redis_image_tag }}'
+    networks:
+      - name: '{{ docker_network_frontend }}'
+
+- name: start container (postgres)
+  docker_container:
+    name: '{{ gitlab_db_container_name }}'
+    detach: true
+    restart_policy: '{{ docker_restart_policy }}'
+    volumes:
+    - '{{ gitlab_db_dv_name }}:/var/lib/postgresql/data'
+    image: '{{ gitlab_db_image_name }}:{{ gitlab_db_image_tag }}'
+    networks:
+    - name: '{{ docker_network_frontend }}'
+    env:
+      POSTGRES_DB: "gitlabhq_production"
+      POSTGRES_USER: "{{ gitlab_db_user }}"
+      POSTGRES_PASSWORD: "{{ gitlab_db_password | quote }}"
+
+- name: Wait for container (postgres)
+  command: >
+    docker exec --user postgres
+    {{ gitlab_db_container_name }}
+    psql -l
+  register: output
+  retries: 10
+  delay: 3
+  until: output.rc == 0
+
+- name: create container (gitlab)
+  docker_container:
+    name: '{{ gitlab_container_name }}'
+    detach: true
+    restart_policy: '{{ docker_restart_policy }}'
+    hostname: '{{ gitlab_hostname }}'
+    ports: '{{ gitlab_port_args }}'
+    networks:
+    - name: '{{ docker_network_frontend }}'
+    volumes:
+    - '{{ openssl_dv_name }}:/etc/ssl/private:ro'
+    - '{{ gitlab_dv_name }}:/home/git/data'
+    - '{{ gitlab_docker_backup_dir }}:/home/git/backups'
+    env:
+      DEBUG: 'true'
+      DEBUG_ENTRYPOINT: 'true'
+      GITLAB_TIMEZONE: "America\\/Chicago"
+      GITLAB_HOST: "{{ gitlab_hostname }}"
+      GITLAB_SSH_HOST: "{{ gitlab_hostname }}"
+      DB_HOST: "{{ gitlab_db_container_name }}"
+      DB_USER: "{{ gitlab_db_user }}"
+      DB_PASS: "{{ gitlab_db_password | quote }}"
+      REDIS_HOST: "{{ gitlab_redis_container_name }}"
+      SMTP_HOST: "{{ exim4_hostname }}"
+      SMTP_PASS: "{{ gitlab_email_password | quote }}"
+      LDAP_PASS: "{{ openldap_proxyagent_password | quote }}"
+      GITLAB_ROOT_PASSWORD: "{{ gitlab_root_password | quote }}"
+      GITLAB_SECRETS_DB_KEY_BASE: "{{ gitlab_secrets_db_key_base | quote }}"
+      SSL_DHPARAM_PATH: /etc/ssl/private/dhparam.pem
+    env_file: '{{ docker_restore_config_base_dir }}/{{ gitlab_dv_name }}/gitlab.env.list'
+    image: '{{ gitlab_image_name }}'
+    state: present
+
+- name: copy updated secrets.yml to gitlab
+  block:
+  - copy:
+      src: secrets.yml
+      dest: /tmp/secrets.yml
+  - command: >
+      docker cp /tmp/secrets.yml
+      "{{gitlab_container_name}}:/var/cache/gitlab/config/gitlabhq/secrets.yml"
+  
+- name: start container (gitlab)
+  docker_container:
+    name: '{{ gitlab_container_name }}'
+    state: started
+
+- name: Wait for gitlab to be fully running
+  uri:
+    url: 'https://{{ gitlab_hostname }}/users/sign_in'
+  register: health
+  retries: 10
+  delay: 30
+  until: health.status == 200
+
+# *****************************************************************************
+# Create container registry directory
+- name: Create container registry directory
+  command: >
+    docker exec -u git {{gitlab_container_name}} mkdir -p /home/git/data/shared/registry
+
+
+
+# *****************************************************************************
+# restore?
+
+- include_tasks: restore.yml
+  when: st_gitlab_restore.stat.exists == False
diff --git a/roles/gitlab-sameersbn-8/tasks/restore.yml b/roles/gitlab-sameersbn-8/tasks/restore.yml
new file mode 100644
index 00000000..b9f74ee0
--- /dev/null
+++ b/roles/gitlab-sameersbn-8/tasks/restore.yml
@@ -0,0 +1,54 @@
+---
+# file: roles/docker-gitlab/tasks/restore.yaml
+
+# *****************************************************************************
+# Get data from tape
+
+- name: find files
+  files_in_dir:
+    path: '{{ gitlab_docker_restore_dir }}'
+  register: gitlab_backup
+
+- name: data from tape
+  bacula:
+    command: restore
+    storage: '{{ bacula_storage }}'
+    fileset: '{{ bacula_fileset }}'
+    dest: '{{ bacula_dest }}'
+    path_to_restore: '{{ gitlab_docker_backup_dir }}'
+  when: gitlab_backup.file_list == []
+
+- name: find files
+  files_in_dir:
+    path: '{{ gitlab_docker_restore_dir }}'
+  register: gitlab_backup
+
+- name: File permissions
+  file:
+    path: '{{ gitlab_docker_restore_dir }}/{{ item }}'
+    state: touch
+    owner: root
+    group: root
+    mode: 'u=rwx,g=rwx,o='
+  with_items: '{{ gitlab_backup.file_list | default([]) }}'
+
+# *****************************************************************************
+# restore the gitlap backup
+
+- name: gitlab restore script
+  command: '{{ docker_projects_dir }}/docker-gitlab/gitlab.sh restore'
+  args:
+    chdir: '{{ docker_restore_config_base_dir }}/{{ gitlab_dv_name }}/'
+  when: gitlab_backup.file_list != []
+
+# *****************************************************************************
+# cleanup
+
+- name: Remove files
+  file:
+    path: '{{ gitlab_docker_restore_dir }}'
+    state: absent
+
+- name: State file
+  shell: 'date --rfc-3339=seconds > {{ docker_restore_config_base_dir }}/{{ gitlab_dv_name }}/restore.date.txt'
+  when: st_gitlab_restore.stat.exists == False
diff --git a/roles/gitlab-sameersbn-8/tasks/upgrade.yml b/roles/gitlab-sameersbn-8/tasks/upgrade.yml
new file mode 100644
index 00000000..3f03ba2c
--- /dev/null
+++ b/roles/gitlab-sameersbn-8/tasks/upgrade.yml
@@ -0,0 +1,32 @@
+---
+
+- assert:
+    that: old_prefix is defined
+
+- name: Shut down old version
+  docker_container: 
+    name: '{{ old_prefix }}{{ item }}'
+    state: stopped
+  loop:
+  - gitlab
+  - gitlab-redis
+  - gitlab-db
+
+- name: Clone volumes
+  docker_volume_clone:
+    src: '{{old_prefix}}{{item}}'
+    dest: '{{ docker_name_prefix }}{{item}}'
+  loop:
+  - gitlab_DV
+  - gitlab_db_DV
+
+- name: State file
+  shell: 'date --rfc-3339=seconds > {{ docker_restore_config_base_dir }}/{{ gitlab_dv_name }}/restore.date.txt'
+  when: st_gitlab_restore.stat.exists == False
+
+- name: exists - state file
+  stat:
+    path: '{{ docker_restore_config_base_dir }}/{{ gitlab_dv_name }}/restore.date.txt'
+    get_checksum: False
+    get_md5: False
+  register: st_gitlab_restore
diff --git a/roles/gitlab-sameersbn-8/templates/after_backup.j2 b/roles/gitlab-sameersbn-8/templates/after_backup.j2
new file mode 100644
index 00000000..85b103f0
--- /dev/null
+++ b/roles/gitlab-sameersbn-8/templates/after_backup.j2
@@ -0,0 +1,6 @@
+{% if gitlab_docker_backup_dir is defined %}
+
+# *****************************************************************************
+# Clean up git
+docker run --rm -v {{ docker_backup_dir }}:/tmp/import_export:z debian:latest bash -c "rm -rf /tmp/import_export/GIT"
+{% endif %}
diff --git a/roles/gitlab-sameersbn-8/templates/before_backup.j2 b/roles/gitlab-sameersbn-8/templates/before_backup.j2
new file mode 100644
index 00000000..d304bcb7
--- /dev/null
+++ b/roles/gitlab-sameersbn-8/templates/before_backup.j2
@@ -0,0 +1,10 @@
+{% if gitlab_docker_backup_dir is defined %}
+
+# *****************************************************************************
+# Backup gitlab
+docker run --rm -v {{ docker_backup_dir }}:/tmp/import_export:z debian:latest bash -c "rm -rf /tmp/import_export/GIT"
+mkdir -p -m u=rwx,g=rwx,o= {{ gitlab_docker_backup_dir }}
+pushd {{ docker_restore_config_base_dir }}/{{ gitlab_dv_name }}
+./gitlab.sh backup
+popd
+{% endif %}
diff --git a/roles/gitlab-sameersbn-8/templates/config.sh.j2 b/roles/gitlab-sameersbn-8/templates/config.sh.j2
new file mode 100644
index 00000000..4df5fa31
--- /dev/null
+++ b/roles/gitlab-sameersbn-8/templates/config.sh.j2
@@ -0,0 +1,19 @@
+# *****************************************************************************
+# Variables used in the backup/restore/import scripts
+
+DOCKER_IMAGE_TAG='{{ docker_image_tag }}'
+
+{ # variables for gitLab
+  GITLAB_IMAGE_NAME='{{ gitlab_image_name }}'
+  GITLAB_DV_IMAGE_NAME='{{ gitlab_dv_image_name }}'
+  GITLAB_CONTAINER_NAME='{{ gitlab_container_name }}'
+  GITLAB_DB_CONTAINER_NAME='{{ gitlab_db_container_name }}'
+  GITLAB_REDIS_CONTAINER_NAME='{{ gitlab_redis_container_name }}'
+  GITLAB_DV_NAME='{{ gitlab_dv_name }}'
+  HOST_GITLAB_RESTORE_DIR='{{ gitlab_docker_restore_dir }}'
+  HOST_GITLAB_BACKUP_DIR='{{ gitlab_docker_backup_dir }}'
+
+  # this file should be only readable by root since username and password exist in the file in plain text
+  GITLAB_DB_USER='{{ gitlab_db_user }}'
+  GITLAB_DB_PASSWORD='{{ gitlab_db_password }}'
+}
diff --git a/roles/gitlab-sameersbn-8/vars/main.yml b/roles/gitlab-sameersbn-8/vars/main.yml
new file mode 100644
index 00000000..ed97d539
--- /dev/null
+++ b/roles/gitlab-sameersbn-8/vars/main.yml
@@ -0,0 +1 @@
+---
diff --git a/upgrade.sh b/upgrade.sh
new file mode 100755
index 00000000..b01c7e13
--- /dev/null
+++ b/upgrade.sh
@@ -0,0 +1,14 @@
+#! /bin/bash
+
+#PYTHONUNBUFFERED=1 \
+     
+ANSIBLE_ENABLE_TASK_DEBUGGER=True \
+ANSIBLE_FORCE_COLOR=true \
+ANSIBLE_HOST_KEY_CHECKING=false \
+ANSIBLE_SSH_ARGS='-o UserKnownHostsFile=/dev/null -o IdentitiesOnly=yes -o ControlMaster=auto -o ControlPersist=60s' \
+exec ansible-playbook \
+        --connection=ssh \
+        --timeout=30 \
+        --inventory-file=ansible-playbook/staging \
+        -vvv \
+        ansible-playbook/gitlab.yml "$@"
